
//
//  Closures
//


#include "test.h"


START(one) {
	VM("let a = 3\nfn test() {\nreturn a\n}\nprint(test())");

	// main
	USE_FUNCTION(0);
	ASSERT_PUSH_NUMBER(3.0);
	ASSERT_STORE(0);
	ASSERT_PUSH_FUNCTION(1);
	ASSERT_STORE(1);
	ASSERT_PUSH_NATIVE(0);
	ASSERT_PUSH_LOCAL(1);
	ASSERT_CALL(0);
	ASSERT_CALL(1);
	ASSERT_INSTRUCTION(CODE_POP);
	ASSERT_UPVALUE_CLOSE(0);
	ASSERT_RETURN_NIL();

	// closure
	USE_FUNCTION(1);
	ASSERT_PUSH_UPVALUE(0);
	ASSERT_INSTRUCTION(CODE_RETURN);
}
END()


START_MAIN(closures) {
	RUN(one)
}
END_MAIN()
